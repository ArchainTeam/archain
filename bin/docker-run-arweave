#!/usr/bin/env bash
# -----
# Arweave - Run Docker Container
# -----

TMP_ADDR=${1:-$MINING_ADDR}
ADDR=${TMP_ADDR:?"Specify a mining address as argument or environment variable MINING_ADDR"}

DICR="sudo docker inspect -f {{.State.Running}}"
DCR="sudo docker run -d --restart=unless-stopped"

DIVE="sudo docker inspect -f {{.Name}}"
DVC="sudo docker volume create "

# -----
# Functions
# -----

# Check if a container is not running.
function is_not_running {
	if [[ $(${DICR} $1 2>&1) != "true"  ]]
	then
		return 0
	else
		return 1
	fi
}

# Check if a volume not exist.
function does_not_exist {
	if [[ $(${DIVE} $1 2>&1) != $1  ]]
	then
		return 0
	else
		return 1
	fi
}

# Create a docker volume.
function create_volume {
	if does_not_exist $1 ;
	then
		echo "Creating volume $1 ..."
		${DVC} $1
	fi
}

# -----
# Volumes
# -----

create_volume arweave-blocks
create_volume arweave-data
create_volume arweave-logs
create_volume arweave-txs
create_volume arweave-wallets

# -----
# Arweave Server
# -----

ARWEAVEARGS="mine mining_addr ${ADDR} \
	peer 35.178.129.36  peer 18.130.126.49  peer 52.56.119.91   peer 52.33.231.154 \
	peer 34.216.88.202  peer 54.159.24.25   peer 54.175.114.204 peer 13.231.142.3 \
	peer 18.179.119.203 peer 54.93.54.173   peer 18.185.120.46  peer 138.197.131.159 \
	peer 206.189.86.98  peer 209.97.175.74  peer 209.97.160.239 peer 209.97.160.159 \
	peer 206.189.5.91   peer 167.99.99.34   peer 165.227.4.33   peer 206.189.170.147 \
	peer 167.99.98.48   peer 204.48.25.210  peer 159.89.225.231 peer 204.48.27.27 \
	peer 204.48.27.17   peer 209.97.142.167 peer 209.97.142.68  peer 209.97.134.129 \
	peer 209.97.128.161 peer 206.189.121.5  peer 209.97.142.170 peer 209.97.142.169 \
	peer 209.97.142.143"

if is_not_running arweave ;
then
	echo "Starting Arweave Container ..."
	${DCR} -p 1984:1984 \
		-v arweave-blocks:/arweave/blocks \
		-v arweave-data:/arweave/data \
		-v arweave-logs:/arweave/logs \
		-v arweave-txs:/arweave/txs \
		-v arweave-wallets:/arweave/wallets \
		--name arweave arweave $ARWEAVEARGS
fi

# -----
# EOF
# -----

